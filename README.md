
# yc-finops-python-gp

  

решение состоит из двух функций:

- Функция getvocabulary получает список хостов Greenplum из облака и формирует словарь в котором содержатся ID кластеров и соответствующие им значения

- Функция enrichbilling по событию появления/изменения CSV файла выгрузки биллинга из указанного бакета расширяет его значениями лейблов, соответствующими указанным в словаре ID кластеров

  

Для работы решения необходимо:

  

1. Создать бакет

2. В резделе биллинга облачной консоли настроить периодическую выгрузку данных в созданный бакет

3. Создать сервисную учетную запись с правами на чтение/запись в бакет, а а также назначить ей роль viewer для всего облака

4. Для сервисной учетной записи создать ключ AWS

5. Создать секрет Lockbox (запросить доступ к preview сервиса, если его нет) в котором прописать AWS\_ACCESS\_KEY\_ID (id ключа), AWS\_SECRET\_ACCESS\_KEY (секретный ключ) и AWS\_DEFAULT\_REGION = ru-central1

6. Создать функцию getvocabulary (функция должна исполняться с использованием сервисной учетной записи, созданной в п. 3)

7. Для функции создать триггер типа таймер и указать необходимую периодичност обновления файла-словаря

8. Прописать для функции следующие переменные окружения:

- CLOUD\_ID - ID облака

- BUCKET - название бакета, куда должен сохраняться словарь

- FILE\_NAME - название объекта, в который должен сохранятся словарь в рамках заданного бакета

и секреты:

- AWS\_KEY - AWS\_ACCESS\_KEY\_ID из секрета Lockbox созданного на шаге 5

- AWS\_SECRET - AWS\_SECRET\_ACCESS\_KEY из секрета Lockbox созданного на шаге 5

9. Загрузить в функцию архив с файлами index.py и requirements.txt из соответствующей папки проекта и в качестве точки входа указать index.handler, также задать таймаут исполнения - 20с

10. Создать функцию enrichbilling (функция должна исполняться с использованием сервисной учетной записи, созданной в п. 3)

11. Создать триггер для функции. В качестве условия запуска функции указать события S3 - создание объекта в бакете созданном в п. 1

12. Прописать для функции следующие переменные окружения:

- VOCOBJECT - название объекта, в который должен сохранятся словарь в рамках заданного бакета (такое же значение, как указано для FILE\_NAME в п. 8)

- BUCKET - такое же значение, как указано для соответствующей переменной в п. 8

- RESLUTBUCKET- название бакета, в котором будут сохраняться результирующие файлы (его необходимо предсоздать и дать права на запись для сервисной учетной записи, созданной в п. 3)

и секреты:

- AWS\_ACCESS\_KEY\_ID - AWS\_ACCESS\_KEY\_ID из секрета Lockbox созданного на шаге 5

- AWS\_SECRET\_ACCESS\_KEY - AWS\_SECRET\_ACCESS\_KEY из секрета Lockbox созданного на шаге 5

- AWS\_DEFAULT\_REGION - AWS_DEFAULT_REGION из секрета Lockbox созданного на шаге 5

13. Загрузить в функцию архив с файлами index.py и requirements.txt из соответствующей папки проекта и в качестве точки входа указать index.handler, также задать таймаут исполнения - 60с
